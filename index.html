<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Beneficiary Â· Smart Dashboard</title>
    <!-- Font Awesome 6 (free) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            margin: 0;
            background: #f4f6fb;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* header with gradient */
        .app-header {
            background: linear-gradient(145deg, #0f5fa3, #1b7aca);
            color: white;
            padding: 20px 16px 16px 16px;
            box-shadow: 0 4px 12px rgba(0, 40, 80, 0.2);
        }

        .app-header h2 {
            margin: 0;
            font-weight: 600;
            font-size: 1.7rem;
            letter-spacing: -0.3px;
        }

        .app-header .sub {
            opacity: 0.85;
            font-size: 0.9rem;
            margin-top: 4px;
        }

        /* main content area with bottom nav offset */
        .main-content {
            flex: 1;
            padding: 16px 16px 80px 16px;
            max-width: 780px;
            margin: 0 auto;
            width: 100%;
        }

        /* dashboard cards (category stats) */
        .dashboard-row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            border-radius: 22px;
            padding: 14px 18px;
            flex: 1 1 calc(33.33% - 12px);
            min-width: 100px;
            box-shadow: 0 8px 18px -6px rgba(0, 60, 120, 0.15);
            border: 1px solid rgba(25, 118, 210, 0.1);
            backdrop-filter: blur(2px);
            transition: 0.2s;
        }

        .stat-card .cat-name {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            color: #5e6f8d;
            font-weight: 600;
        }

        .stat-card .cat-count {
            font-size: 2rem;
            font-weight: 700;
            color: #0f3b5e;
            line-height: 1.2;
        }

        .stat-card .cat-total {
            font-size: 0.9rem;
            color: #1976d2;
            font-weight: 500;
        }

        /* filter bar */
        .filter-bar {
            background: white;
            padding: 14px 16px;
            border-radius: 28px;
            box-shadow: 0 6px 14px rgba(0, 0, 0, 0.04);
            margin-bottom: 24px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 12px;
            border: 1px solid #e9ecf2;
        }

        .filter-item {
            display: flex;
            align-items: center;
            gap: 6px;
            background: #f1f5fc;
            border-radius: 40px;
            padding: 5px 16px 5px 12px;
        }

        .filter-item label {
            font-weight: 600;
            color: #1e4f7a;
            font-size: 0.9rem;
        }

        .filter-item select,
        .filter-item input {
            border: none;
            background: transparent;
            padding: 8px 0;
            font-size: 0.95rem;
            outline: none;
            font-weight: 500;
            color: #0d3a5e;
        }

        .filter-item i {
            color: #1976d2;
            font-size: 0.9rem;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
            background: #f1f5fc;
            border-radius: 40px;
            padding: 5px 16px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .search-box i {
            color: #1976d2;
            font-size: 1rem;
        }

        .search-box input {
            border: none;
            background: transparent;
            width: 100%;
            padding: 8px 0;
            outline: none;
            font-size: 0.95rem;
        }

        .reset-btn {
            background: none;
            border: 1px solid #cbd6e6;
            border-radius: 30px;
            padding: 6px 14px;
            color: #2a4f77;
            font-weight: 500;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .reset-btn i {
            font-size: 0.9rem;
        }

        .reset-btn:hover {
            background: #e3eaf3;
        }

        /* beneficiary card */
        .bene-card {
            background: white;
            margin: 16px 0;
            padding: 16px 18px;
            border-radius: 26px;
            box-shadow: 0 8px 22px -8px rgba(25, 118, 210, 0.2);
            border: 1px solid rgba(0, 0, 0, 0.02);
            transition: transform 0.1s, box-shadow 0.2s;
            cursor: pointer;
        }

        .bene-card:active {
            transform: scale(0.99);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .row {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 8px;
        }

        .reg-badge {
            background: #e1efff;
            color: #135b9e;
            font-weight: 700;
            padding: 4px 12px;
            border-radius: 50px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .reg-badge i {
            font-size: 0.7rem;
        }

        .name-large {
            font-size: 1.3rem;
            font-weight: 700;
            color: #0e3f66;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .name-large i {
            color: #1976d2;
            font-size: 1.2rem;
        }

        .list-name {
            color: #577a9e;
            font-weight: 500;
            font-size: 0.95rem;
            margin-left: 28px;
        }

        .meta-line {
            display: flex;
            flex-wrap: wrap;
            gap: 12px 20px;
            margin-top: 8px;
            color: #305e83;
            font-weight: 500;
        }

        .meta-line span {
            background: #f0f6fe;
            padding: 4px 12px;
            border-radius: 30px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .meta-line i {
            color: #1976d2;
            font-size: 0.8rem;
        }

        .total-amount {
            font-weight: 700;
            color: #1f6c33;
            background: #e2f0e4;
            padding: 4px 14px;
            border-radius: 40px;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .total-amount i {
            color: #2e7d32;
        }

        .category-tag {
            background: #1976d2;
            color: white;
            padding: 4px 14px;
            border-radius: 40px;
            font-size: 0.8rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* detail view */
        .detail-container {
            background: white;
            border-radius: 32px;
            padding: 20px;
            box-shadow: 0 12px 28px rgba(0, 0, 0, 0.1);
        }

        .backBtn {
            background: #ffffff;
            border: 1px solid #c2d6ed;
            padding: 10px 20px;
            border-radius: 40px;
            font-weight: 600;
            color: #135b9e;
            margin-bottom: 18px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.02);
            cursor: pointer;
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .backBtn i {
            font-size: 1rem;
        }

        .backBtn:hover {
            background: #ecf3fc;
        }

        .accounts-block {
            background: #f4f9ff;
            padding: 16px;
            border-radius: 20px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 0.9rem;
            border: 1px solid #d6e6ff;
        }

        .accounts-block i {
            color: #1976d2;
            margin-right: 6px;
        }

        .payment-item {
            background: #f9fafc;
            padding: 15px;
            border-radius: 18px;
            margin: 12px 0;
            border-left: 5px solid #1b7aca;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
        }

        .payment-item i {
            color: #1976d2;
            width: 20px;
        }

        /* bottom navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(16px);
            display: flex;
            justify-content: space-around;
            padding: 12px 16px 18px 16px;
            box-shadow: 0 -6px 20px rgba(0, 20, 60, 0.12);
            border-top: 1px solid rgba(255, 255, 255, 0.5);
            max-width: 600px;
            margin: 0 auto;
            border-radius: 30px 30px 0 0;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #5c7b9c;
            transition: 0.2s;
            cursor: pointer;
            font-size: 0.8rem;
            background: transparent;
            padding: 4px 16px;
            border-radius: 30px;
            gap: 4px;
        }

        .nav-item i {
            font-size: 1.5rem;
        }

        .nav-item.active {
            color: #1976d2;
            background: #e1f0ff;
            font-weight: 600;
        }

        .info-message {
            background: white;
            border-radius: 40px;
            padding: 30px;
            text-align: center;
            color: #6b85a2;
            font-weight: 500;
        }

        .hidden {
            display: none !important;
        }

        /* filter summary */
        .filter-summary {
            background: #e8f0fe;
            border-radius: 20px;
            padding: 8px 16px;
            margin-bottom: 16px;
            font-size: 0.9rem;
            color: #135b9e;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .filter-summary i {
            color: #1976d2;
        }

        .filter-tag {
            background: white;
            border-radius: 30px;
            padding: 4px 12px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
        }
    </style>
</head>

<body>

    <div class="app-header">
        <h2><i class="fas fa-hand-holding-heart" style="margin-right: 10px;"></i> Sahayata</h2>
        <div class="sub"><i class="fas fa-map-marker-alt" style="margin-right: 5px;"></i> beneficiary directory Â·
            district KALABURAGI</div>
    </div>

    <!-- main content -->
    <div class="main-content" id="mainContent">
        <!-- filter summary (shows active filters) -->
        <div id="filterSummary" class="filter-summary">
            <i class="fas fa-filter"></i>
            <span>Showing: </span>
            <span id="filterTags">all beneficiaries</span>
        </div>

        <!-- dashboard cards (category stats) - now updates based on filters -->
        <div id="dashboardView" class="dashboard-row"></div>

        <!-- filter & search bar -->
        <div id="filterSection" class="filter-bar">
            <div class="filter-item">
                <i class="fas fa-tag"></i>
                <label>Cat</label>
                <select id="catFilter">
                    <option value="ALL">All</option>
                </select>
            </div>
            <div class="filter-item">
                <i class="fas fa-map-pin"></i>
                <label>Reg</label>
                <select id="regFilter">
                    <option value="ALL">All</option>
                </select>
            </div>
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Name, ID, mobile...">
            </div>
            <button class="reset-btn" id="resetFilters"><i class="fas fa-undo-alt"></i> reset</button>
        </div>

        <!-- list container (cards) - visible by default -->
        <div id="listView"></div>

        <!-- detail panel (hidden by default) -->
        <div id="detailView" class="detail-container hidden"></div>
    </div>

    <!-- bottom navigation - removed insights, only dashboard and list -->
    <div class="bottom-nav">
        <div class="nav-item" id="navDashboard" data-tab="dashboard"><i
                class="fas fa-chart-pie"></i><span>Dashboard</span></div>
        <div class="nav-item active" id="navList" data-tab="list"><i
                class="fas fa-list-ul"></i><span>Beneficiaries</span></div>
    </div>

    <script>
        (function () {
            const API_URL = "https://script.google.com/macros/s/AKfycbx3fCb2J4j3V3Vw4DXWVLudHA9uqxdNq-s6Zt1bgptKlJZPbJfiH77MVbAJqUhYmBwHDA/exec?api=1";

            let DATA = [];               // raw data
            let filteredData = [];        // after filter+search

            // DOM elements
            const dashboardDiv = document.getElementById('dashboardView');
            const listViewDiv = document.getElementById('listView');
            const detailViewDiv = document.getElementById('detailView');
            const filterSection = document.getElementById('filterSection');
            const filterSummary = document.getElementById('filterSummary');
            const filterTags = document.getElementById('filterTags');
            const catSelect = document.getElementById('catFilter');
            const regSelect = document.getElementById('regFilter');
            const searchInput = document.getElementById('searchInput');
            const resetBtn = document.getElementById('resetFilters');

            // navigation
            const navDashboard = document.getElementById('navDashboard');
            const navList = document.getElementById('navList');
            let activeTab = 'list';   // default to beneficiaries tab

            // Helper function to safely convert any value to string for searching
            function safeToString(value) {
                if (value === null || value === undefined) return '';
                return String(value).toLowerCase();
            }

            // Update filter summary display
            function updateFilterSummary() {
                const cat = catSelect.value;
                const reg = regSelect.value;
                const query = searchInput.value.trim();

                let tags = [];
                if (cat !== 'ALL') tags.push(`<span class="filter-tag"><i class="fas fa-tag"></i> ${cat}</span>`);
                if (reg !== 'ALL') tags.push(`<span class="filter-tag"><i class="fas fa-map-pin"></i> ${reg}</span>`);
                if (query) tags.push(`<span class="filter-tag"><i class="fas fa-search"></i> "${query}"</span>`);

                if (tags.length === 0) {
                    filterTags.innerHTML = 'all beneficiaries';
                } else {
                    filterTags.innerHTML = tags.join(' ');
                }
            }

            // ---- load ----
            async function loadData() {
                try {
                    const res = await fetch(API_URL);
                    DATA = await res.json();
                    // ensure payments array (handle if missing)
                    DATA = DATA.map((b, idx) => {
                        if (!b.Payments) b.Payments = [];
                        if (!b.Accounts) b.Accounts = ['(no account)'];
                        if (!b.Category) b.Category = 'General';
                        if (!b.Reg) b.Reg = 'REG00';
                        // compute total amount from Payments if not present
                        if (!b.TotalAmount && b.Payments.length) {
                            b.TotalAmount = b.Payments.reduce((acc, p) => acc + (p.Amount || 0), 0);
                        } else if (!b.TotalAmount) b.TotalAmount = 0;
                        b.PaymentCount = b.Payments.length;
                        return b;
                    });
                    populateFilters();
                    applyFilterAndRender();
                } catch (e) {
                    console.warn("Error loading data, using demo data:", e);
                    // fallback demo data
                    DATA = generateDemoData();
                    populateFilters();
                    applyFilterAndRender();
                }
            }

            // demo data if api fails
            function generateDemoData() {
                const cats = ['SC', 'ST', 'OBC', 'General', 'Minority'];
                const regs = ['REG001', 'REG002', 'REG003', 'REG004'];
                let arr = [];
                for (let i = 1; i <= 24; i++) {
                    let cat = cats[Math.floor(Math.random() * cats.length)];
                    let reg = regs[Math.floor(Math.random() * regs.length)];
                    arr.push({
                        Reg: reg,
                        Sl: i,
                        RCNO: `RC${1000 + i}`,
                        BeneID: `BEN${3000 + i}`,
                        BeneName: `Person ${i}`,
                        BeneListName: `à¤…à¤§à¤¿à¤•à¤¾à¤°à¥€ ${i}`,
                        MobileNo: `987654${1000 + i}`,
                        Address: `Ward ${i}, Main Road`,
                        Category: cat,
                        TotalAmount: Math.floor(Math.random() * 50000) + 5000,
                        Accounts: [`SBIN00${i}`, `PYTM${i}`],
                        PaymentCount: Math.floor(Math.random() * 5),
                        Payments: Array.from({ length: Math.floor(Math.random() * 4) }, (_, idx) => ({
                            Date: `2025-0${idx + 1}-10`,
                            Amount: Math.floor(Math.random() * 8000) + 500,
                            RequisitionID: `REQ${idx}${i}`,
                            Fund: 'State Plan'
                        }))
                    });
                }
                return arr;
            }

            // fill filter dropdowns dynamically
            function populateFilters() {
                const cats = [...new Set(DATA.map(d => d.Category).filter(Boolean))];
                const regs = [...new Set(DATA.map(d => d.Reg).filter(Boolean))];
                catSelect.innerHTML = '<option value="ALL">All Categories</option>' + cats.map(c => `<option value="${c}">${c}</option>`).join('');
                regSelect.innerHTML = '<option value="ALL">All Regions</option>' + regs.map(r => `<option value="${r}">${r}</option>`).join('');
            }

            // filter logic
            function filterData() {
                const cat = catSelect.value;
                const reg = regSelect.value;
                const query = searchInput.value.trim().toLowerCase();

                filteredData = DATA.filter(item => {
                    // Category filter
                    if (cat !== 'ALL' && item.Category !== cat) return false;

                    // Region filter
                    if (reg !== 'ALL' && item.Reg !== reg) return false;

                    // Search query - safely convert all fields to strings
                    if (query) {
                        const searchableFields = [
                            safeToString(item.BeneName),
                            safeToString(item.BeneListName),
                            safeToString(item.BeneID),
                            safeToString(item.MobileNo),
                            safeToString(item.RCNO),
                            safeToString(item.Address)
                        ];

                        // Check if query appears in any field
                        return searchableFields.some(field => field.includes(query));
                    }

                    return true;
                });

                updateFilterSummary();
            }

            // update dashboard stats based on FILTERED data (not all data)
            function renderDashboard() {
                const categoryMap = new Map();

                // Use filteredData for dashboard stats
                const dataForDashboard = filteredData.length > 0 ? filteredData : DATA;

                dataForDashboard.forEach(item => {
                    const cat = item.Category || 'Uncategorized';
                    if (!categoryMap.has(cat)) categoryMap.set(cat, { count: 0, total: 0 });
                    const rec = categoryMap.get(cat);
                    rec.count += 1;
                    rec.total += (item.TotalAmount || 0);
                });

                let html = '';
                if (categoryMap.size === 0) {
                    html = '<div class="info-message"><i class="fas fa-chart-line"></i> No data for selected filters</div>';
                } else {
                    for (let [cat, val] of categoryMap.entries()) {
                        html += `<div class="stat-card">
                            <div class="cat-name"><i class="fas fa-layer-group" style="margin-right: 4px;"></i>${cat}</div>
                            <div class="cat-count">${val.count}</div>
                            <div class="cat-total"><i class="fas fa-rupee-sign"></i> ${val.total.toLocaleString()}</div>
                        </div>`;
                    }
                }
                dashboardDiv.innerHTML = html;
            }

            // render list cards (filteredData)
            function renderList() {
                if (filteredData.length === 0) {
                    listViewDiv.innerHTML = '<div class="info-message"><i class="fas fa-users-slash"></i> âœ¨ No matching beneficiaries</div>';
                    return;
                }

                let cardsHtml = '';
                filteredData.forEach((b, idx) => {
                    // Find original index for showDetail
                    const originalIndex = DATA.findIndex(item =>
                        item.BeneID === b.BeneID && item.Sl === b.Sl
                    );

                    cardsHtml += `
                        <div class="bene-card" onclick="window.app.showDetail(${originalIndex >= 0 ? originalIndex : 0})">
                            <div class="row">
                                <span class="reg-badge"><i class="fas fa-hashtag"></i> ${b.Reg || 'REG'}</span>
                                <span class="category-tag"><i class="fas fa-tag"></i> ${b.Category || 'â€”'}</span>
                            </div>
                            <div class="name-large">
                                <i class="fas fa-user-circle"></i> ${b.BeneName || 'Unknown'}
                            </div>
                            <div class="list-name">${b.BeneListName || ''}</div>
                            <div class="meta-line">
                                <span><i class="fas fa-id-card"></i> ${b.BeneID || ''}</span>
                                <span><i class="fas fa-mobile-alt"></i> ${b.MobileNo || ''}</span>
                                <span><i class="fas fa-file-invoice"></i> RC:${b.RCNO || ''}</span>
                            </div>
                            <div class="row" style="margin-top: 10px;">
                                <span class="total-amount"><i class="fas fa-rupee-sign"></i> ${(b.TotalAmount || 0).toLocaleString()}</span>
                                <span><i class="fas fa-credit-card"></i> ${b.PaymentCount || 0} payments</span>
                            </div>
                        </div>`;
                });
                listViewDiv.innerHTML = cardsHtml;
            }

            // main render after filtering
            function applyFilterAndRender() {
                filterData();
                renderDashboard();      // dashboard always shows stats for filtered data

                if (activeTab === 'dashboard') {
                    listViewDiv.style.display = 'none';
                    dashboardDiv.style.display = 'flex';
                } else {
                    listViewDiv.style.display = 'block';
                    dashboardDiv.style.display = 'none';
                    renderList();
                }

                // hide detail if open
                if (!detailViewDiv.classList.contains('hidden')) {
                    detailViewDiv.classList.add('hidden');
                    filterSection.style.display = 'flex';
                    filterSummary.style.display = 'flex';
                }
            }

            // show detail by original index
            function showDetail(originalIndex) {
                if (originalIndex < 0 || originalIndex >= DATA.length) return;
                const b = DATA[originalIndex];

                // hide list / dashboard, show detail
                listViewDiv.style.display = 'none';
                dashboardDiv.style.display = 'none';
                filterSection.style.display = 'none';
                filterSummary.style.display = 'none';
                detailViewDiv.classList.remove('hidden');

                let paymentsHtml = '';
                if (b.Payments && b.Payments.length) {
                    b.Payments.forEach(p => {
                        paymentsHtml += `<div class="payment-item">
                            <i class="fas fa-calendar-alt"></i> ðŸ“… ${p.Date || 'N/A'} Â· <i class="fas fa-rupee-sign"></i> ${(p.Amount || 0).toLocaleString()}<br>
                            <i class="fas fa-hashtag"></i> ðŸ”– ReqID: ${p.RequisitionID || 'â€”'}<br>
                            <i class="fas fa-coins"></i> ðŸ’µ Fund: ${p.Fund || 'â€”'}
                        </div>`;
                    });
                } else {
                    paymentsHtml = '<div class="payment-item"><i class="fas fa-info-circle"></i> No payment records</div>';
                }

                const accountsHtml = Array.isArray(b.Accounts) ? b.Accounts.join('<br>') : (b.Accounts || 'â€”');

                detailViewDiv.innerHTML = `
                    <button class="backBtn" id="manualBackBtn"><i class="fas fa-arrow-left"></i> Back to list</button>
                    <div style="background:#ebf3fe; border-radius:28px; padding:20px;">
                        <h2 style="margin:0 0 6px; color:#12437c;"><i class="fas fa-user-circle"></i> ${b.BeneName}</h2>
                        <div style="color:#2c5779;"><i class="fas fa-font"></i> ${b.BeneListName || ''}</div>
                        <div class="accounts-block">
                            <strong><i class="fas fa-university"></i> Accounts</strong><br>${accountsHtml}
                        </div>
                        <div style="display:flex; gap:16px; flex-wrap:wrap; margin:12px 0;">
                            <span><strong><i class="fas fa-credit-card"></i> Payments:</strong> ${b.PaymentCount || 0}</span>
                            <span><strong><i class="fas fa-rupee-sign"></i> Total:</strong> â‚¹${(b.TotalAmount || 0).toLocaleString()}</span>
                        </div>
                        <h4 style="margin:12px 0 4px;"><i class="fas fa-history"></i> Payment history</h4>
                        ${paymentsHtml}
                    </div>
                `;

                document.getElementById('manualBackBtn').addEventListener('click', goBack);
            }

            function goBack() {
                detailViewDiv.classList.add('hidden');
                filterSection.style.display = 'flex';
                filterSummary.style.display = 'flex';
                // restore based on active tab
                if (activeTab === 'list') {
                    listViewDiv.style.display = 'block';
                    dashboardDiv.style.display = 'none';
                } else {
                    listViewDiv.style.display = 'none';
                    dashboardDiv.style.display = 'flex';
                }
            }

            // navigation handlers
            function setActiveTab(tab) {
                activeTab = tab;
                navDashboard.classList.remove('active');
                navList.classList.remove('active');

                if (tab === 'dashboard') {
                    navDashboard.classList.add('active');
                    dashboardDiv.style.display = 'flex';
                    listViewDiv.style.display = 'none';
                } else {
                    navList.classList.add('active');
                    dashboardDiv.style.display = 'none';
                    listViewDiv.style.display = 'block';
                    renderList();
                }

                // if detail is open, hide it on tab switch
                if (!detailViewDiv.classList.contains('hidden')) {
                    detailViewDiv.classList.add('hidden');
                    filterSection.style.display = 'flex';
                    filterSummary.style.display = 'flex';
                }
            }

            // expose functions globally for onclick
            window.app = {
                showDetail: (idx) => showDetail(idx),
                goBack: goBack
            };

            // reset filters
            resetBtn.addEventListener('click', () => {
                catSelect.value = 'ALL';
                regSelect.value = 'ALL';
                searchInput.value = '';
                applyFilterAndRender();
                if (activeTab === 'list') renderList();
            });

            // filter change events - update both dashboard and list
            catSelect.addEventListener('change', applyFilterAndRender);
            regSelect.addEventListener('change', applyFilterAndRender);
            searchInput.addEventListener('input', applyFilterAndRender);

            // bottom nav
            navDashboard.addEventListener('click', () => setActiveTab('dashboard'));
            navList.addEventListener('click', () => setActiveTab('list'));

            // initial load - beneficiaries first (activeTab = 'list')
            loadData();

            // helper to goBack from global
            window.goBack = function () { window.app.goBack(); };

        })();
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }
    </script>
</body>

</html>